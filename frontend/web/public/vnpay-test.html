<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test VNPay Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">üè¶ Test Thanh To√°n VNPay</h4>
                        <small>M√¥i tr∆∞·ªùng Sandbox - Terminal ID: 16EMRWXG</small>
                    </div>
                    <div class="card-body">
                        <!-- Th√¥ng tin th·∫ª test -->
                        <div class="alert alert-info">
                            <h6><strong>üè¶ Th√¥ng tin th·∫ª test VNPay:</strong></h6>
                            <ul class="mb-0">
                                <li><strong>Ng√¢n h√†ng:</strong> NCB</li>
                                <li><strong>S·ªë th·∫ª:</strong> 9704198526191432198</li>
                                <li><strong>T√™n ch·ªß th·∫ª:</strong> NGUYEN VAN A</li>
                                <li><strong>Ng√†y ph√°t h√†nh:</strong> 07/15</li>
                                <li><strong>M·∫≠t kh·∫©u OTP:</strong> 123456</li>
                            </ul>
                        </div>

                        <form id="vnpayForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="amount" class="form-label">S·ªë ti·ªÅn (VND) *</label>
                                        <input type="number" class="form-control" id="amount" value="100000" min="5000"
                                            required>
                                        <div class="form-text">T·ªëi thi·ªÉu 5,000 VND</div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="orderInfo" class="form-label">Th√¥ng tin ƒë∆°n h√†ng</label>
                                        <input type="text" class="form-control" id="orderInfo"
                                            value="Test thanh toan VNPay">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">H·ªç t√™n kh√°ch h√†ng *</label>
                                        <input type="text" class="form-control" id="customerName" value="Nguy·ªÖn VƒÉn A"
                                            required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                                        <input type="tel" class="form-control" id="customerPhone" value="0123456789"
                                            required>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="customerEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="customerEmail" value="test@example.com"
                                    required>
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                                <textarea class="form-control" id="address" rows="2"
                                    required>123 ƒê∆∞·ªùng Test, Ph∆∞·ªùng Test, Qu·∫≠n Test, TP.HCM</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="token" class="form-label">Token x√°c th·ª±c</label>
                                <input type="text" class="form-control" id="token" readonly
                                    placeholder="S·∫Ω l·∫•y t·ª´ localStorage">
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100" id="payButton">
                                üí≥ Thanh to√°n VNPay
                            </button>
                        </form>

                        <div id="result" class="mt-4"></div>
                    </div>
                </div>

                <!-- Debug Log -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>üìù Debug Log</h5>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLog()">X√≥a log</button>
                    </div>
                    <div class="card-body">
                        <pre id="debugLog"
                            style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug logging function
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            debugLog.textContent += `[${timestamp}] ${icon} ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`${icon} ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        // Load token from localStorage
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('token');
            document.getElementById('token').value = token || '';

            if (token) {
                log('Token t√¨m th·∫•y trong localStorage', 'success');
            } else {
                log('Kh√¥ng t√¨m th·∫•y token - B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc', 'warning');
            }
        });

        // Handle form submission
        document.getElementById('vnpayForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const amount = parseInt(document.getElementById('amount').value);
            const orderInfo = document.getElementById('orderInfo').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const address = document.getElementById('address').value;

            const payButton = document.getElementById('payButton');
            const resultDiv = document.getElementById('result');

            // Validation
            if (!token) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc! Token kh√¥ng t·ªìn t·∫°i.</div>';
                log('Kh√¥ng c√≥ token x√°c th·ª±c', 'error');
                return;
            }

            if (amount < 5000) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå S·ªë ti·ªÅn ph·∫£i t·ªëi thi·ªÉu 5,000 VND</div>';
                log('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá: ' + amount, 'error');
                return;
            }

            if (!customerName || !customerPhone || !customerEmail || !address) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
                log('Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc', 'error');
                return;
            }

            // Disable button and show loading
            payButton.disabled = true;
            payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';
            resultDiv.innerHTML = '<div class="alert alert-info">üîÑ ƒêang t·∫°o thanh to√°n VNPay...</div>';

            log(`B·∫Øt ƒë·∫ßu t·∫°o thanh to√°n VNPay`);
            log(`S·ªë ti·ªÅn: ${amount.toLocaleString()} VND`);
            log(`Th√¥ng tin: ${orderInfo}`);

            try {
                const requestData = {
                    amount: amount,
                    orderInfo: orderInfo,
                    orderType: 'other',
                    // Th√¥ng tin ƒë∆°n h√†ng gi·∫£ l·∫≠p
                    dia_chi_giao_hang: address,
                    phuong_thuc_thanh_toan: 'VNPAY',
                    ghi_chu: 'Test payment',
                    shippingFee: 30000,
                    danh_sach_san_pham: [{
                        id: '507f1f77bcf86cd799439011', // ObjectId gi·∫£
                        size: 'M',
                        color: 'ƒê·ªè',
                        quantity: 1
                    }],
                    discount: 0,
                    voucher: null
                };

                log(`G·ª≠i request ƒë·∫øn API: ${JSON.stringify(requestData, null, 2)}`);

                const response = await fetch('http://localhost:5000/api/payment/vnpay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                log(`Response status: ${response.status} ${response.statusText}`);

                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`);

                if (response.ok && data.success && data.paymentUrl) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ T·∫°o thanh to√°n th√†nh c√¥ng!<br>
                            <strong>Order ID:</strong> ${data.orderId}<br>
                            <strong>Amount:</strong> ${data.amount.toLocaleString()} VND<br>
                            <strong>Bill ID:</strong> ${data.billId}<br>
                            <div class="mt-3">
                                <a href="${data.paymentUrl}" target="_blank" class="btn btn-success">
                                    üöÄ ƒêi ƒë·∫øn trang thanh to√°n VNPay
                                </a>
                                <button class="btn btn-info ms-2" onclick="copyToClipboard('${data.paymentUrl}')">
                                    üìã Copy URL
                                </button>
                            </div>
                        </div>
                    `;
                    log(`Payment URL t·∫°o th√†nh c√¥ng: ${data.paymentUrl}`, 'success');
                    log(`Order ID: ${data.orderId}`, 'success');

                    // Auto redirect sau 3 gi√¢y
                    setTimeout(() => {
                        log('T·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay...', 'info');
                        window.open(data.paymentUrl, '_blank');
                    }, 3000);

                } else {
                    throw new Error(data.message || 'Kh√¥ng t·∫°o ƒë∆∞·ª£c payment URL');
                }

            } catch (error) {
                log(`L·ªói: ${error.message}`, 'error');

                let errorMessage = error.message;
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Ki·ªÉm tra server c√≥ ƒëang ch·∫°y kh√¥ng?';
                }

                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå <strong>L·ªói:</strong> ${errorMessage}
                        <br><small class="text-muted">Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt</small>
                    </div>
                `;
            } finally {
                // Re-enable button
                payButton.disabled = false;
                payButton.innerHTML = 'üí≥ Thanh to√°n VNPay';
            }
        });

        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                log('ƒê√£ copy URL v√†o clipboard', 'success');
            }).catch(() => {
                log('Kh√¥ng th·ªÉ copy URL', 'error');
            });
        }

        // Log initial state
        log('Test VNPay form loaded successfully');
        log('Terminal ID: 16EMRWXG (Sandbox)');
        log('S·∫µn s√†ng test thanh to√°n');
    </script>
</body>

</html>